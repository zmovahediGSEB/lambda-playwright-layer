name: Build Lambda Layer for Selenium, ChromeDriver, and Headless Chromium

on:
  push:
    branches:
      - main

jobs:
  build-selenium-layer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Selenium and dependencies
        run: |
          python -m venv venv_selenium
          source venv_selenium/bin/activate
          pip install --upgrade pip
          pip install selenium

      - name: Download ChromeDriver
        run: |
          CHROMEDRIVER_VERSION=$(curl -sS https://chromedriver.storage.googleapis.com/LATEST_RELEASE)
          curl -O https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip -d chromedriver
          chmod +x chromedriver/chromedriver

      - name: Download Headless Chromium
        run: |
          mkdir -p chromium
          # Download the ZIP archive containing Chromium
          curl -L -o chromium.zip https://github.com/adieuadieu/serverless-chrome/releases/download/v1.0.0-57/stable-headless-chromium-amazonlinux-2.zip
          # Extract the ZIP archive into the chromium directory
          unzip chromium.zip -d chromium
          # Make the Chromium binary executable
          chmod +x chromium/headless-chromium

      - name: Prepare Lambda layer directory
        run: |
          mkdir -p layer/python
          source venv_selenium/bin/activate
          pip install --target=layer/python selenium

          # Copy ChromeDriver and Chromium into the layer
          cp -r chromedriver layer/python/
          cp -r chromium layer/python/

      - name: Create ZIP for Selenium Layer
        run: |
          cd layer
          zip -r ../selenium-layer.zip .

      - name: Upload Layer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: selenium-layer
          path: selenium-layer.zip
